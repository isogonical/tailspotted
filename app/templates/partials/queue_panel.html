<div class="queue-panel-header">
    <h2>Queue</h2>
    <button class="queue-close-btn" onclick="document.getElementById('queue-overlay').classList.remove('active'); document.getElementById('queue-panel').classList.remove('active');">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
    </button>
</div>

<div class="queue-stats" hx-get="/queue/stats" hx-trigger="every 5s" hx-swap="innerHTML" hx-target="#queue-panel-content">
    <!-- Status grid -->
    <div class="queue-stat-grid">
        <div class="queue-stat">
            <span class="queue-stat-number running">{{ running }}</span>
            <span class="queue-stat-label">Scanning</span>
        </div>
        <div class="queue-stat">
            <span class="queue-stat-number pending">{{ pending }}</span>
            <span class="queue-stat-label">Queued</span>
        </div>
        <div class="queue-stat">
            <span class="queue-stat-number failed">{{ failed }}</span>
            <span class="queue-stat-label">Failed</span>
        </div>
        <div class="queue-stat">
            <span class="queue-stat-number completed">{{ completed }}</span>
            <span class="queue-stat-label">Done</span>
        </div>
    </div>

    {% if blocked > 0 %}
    <div class="queue-stat-blocked">
        <span class="queue-stat-number blocked">{{ blocked }}</span> blocked
    </div>
    {% endif %}

    <!-- ETA -->
    <div class="queue-eta">
        {% if paused %}
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
            Paused
        {% elif pending == 0 and running == 0 %}
            Queue empty
        {% elif eta_minutes >= 60 %}
            ~{{ eta_minutes // 60 }}h {{ eta_minutes % 60 }}m remaining
        {% elif eta_minutes > 0 %}
            ~{{ eta_minutes }} min remaining
        {% else %}
            Processing...
        {% endif %}
    </div>

    <!-- Controls -->
    <div class="queue-controls">
        <h3>Controls</h3>

        {% if paused %}
        <button class="btn btn-small btn-primary queue-control-btn"
                hx-post="/queue/resume"
                hx-target="#queue-panel-content"
                hx-swap="innerHTML">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg>
            Resume
        </button>
        {% else %}
        <button class="btn btn-small queue-control-btn"
                hx-post="/queue/pause"
                hx-target="#queue-panel-content"
                hx-swap="innerHTML">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
            Pause
        </button>
        {% endif %}

        <button class="btn btn-small queue-reprocess-btn"
                hx-post="/queue/reprocess"
                hx-target="#queue-panel-content"
                hx-swap="innerHTML"
                hx-confirm="This will reset all running and failed jobs back to pending and restart processing. Continue?">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6"/><path d="M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
            Re-process queue
        </button>

        <form class="queue-settings-form"
              hx-post="/queue/settings"
              hx-target="#queue-panel-content"
              hx-swap="innerHTML">
            <div class="queue-setting-row">
                <label for="max_jobs">Concurrent jobs</label>
                <select name="max_jobs" id="max_jobs" class="queue-select" onchange="this.form.requestSubmit()">
                    {% for n in range(1, 11) %}
                    <option value="{{ n }}" {% if n == max_jobs %}selected{% endif %}>{{ n }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="queue-setting-row">
                <label for="job_delay">Delay between jobs</label>
                <select name="job_delay" id="job_delay" class="queue-select" onchange="this.form.requestSubmit()">
                    <option value="0" {% if job_delay == 0 %}selected{% endif %}>None</option>
                    <option value="2" {% if job_delay == 2 %}selected{% endif %}>2s</option>
                    <option value="5" {% if job_delay == 5 %}selected{% endif %}>5s</option>
                    <option value="10" {% if job_delay == 10 %}selected{% endif %}>10s</option>
                    <option value="30" {% if job_delay == 30 %}selected{% endif %}>30s</option>
                    <option value="60" {% if job_delay == 60 %}selected{% endif %}>60s</option>
                </select>
            </div>
            <div class="queue-setting-row">
                <label for="rescan_interval">Rescan interval</label>
                <select name="rescan_interval" id="rescan_interval" class="queue-select" onchange="this.form.requestSubmit()">
                    <option value="24" {% if rescan_interval == 24 %}selected{% endif %}>Daily</option>
                    <option value="72" {% if rescan_interval == 72 %}selected{% endif %}>3 days</option>
                    <option value="168" {% if rescan_interval == 168 %}selected{% endif %}>7 days</option>
                    <option value="336" {% if rescan_interval == 336 %}selected{% endif %}>14 days</option>
                    <option value="720" {% if rescan_interval == 720 %}selected{% endif %}>30 days</option>
                    <option value="0" {% if rescan_interval == 0 %}selected{% endif %}>Never</option>
                </select>
            </div>
        </form>

        {% if failed > 0 %}
        <button class="btn btn-small queue-retry-btn"
                hx-post="/queue/retry-failed"
                hx-target="#queue-panel-content"
                hx-swap="innerHTML">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
            Retry {{ failed }} failed
        </button>
        {% endif %}
    </div>

    <!-- Upcoming Rescans -->
    <div class="queue-rescan-section">
        <h3>Upcoming Rescans</h3>
        {% if rescan_interval == 0 %}
        <div class="queue-rescan-info">
            <span class="queue-rescan-next">Rescans disabled</span>
        </div>
        {% elif upcoming_count > 0 %}
        <div class="queue-rescan-info">
            <span class="queue-rescan-count">{{ upcoming_count }} scheduled</span>
            {% if next_rescan_str %}
            <span class="queue-rescan-next">next in {{ next_rescan_str }}</span>
            {% endif %}
        </div>
        {% else %}
        <div class="queue-rescan-info">
            <span class="queue-rescan-next">No rescans scheduled</span>
        </div>
        {% endif %}
    </div>

    {% if failed_jobs %}
    <div class="queue-failed-section">
        <h3>Failed Jobs</h3>
        {% set source_names = {
            'airlinersnet': 'Airliners.net',
            'jetphotos': 'JetPhotos',
            'planespotters': 'Planespotters.net',
            'airplane_pictures': 'Airplane-Pictures.net',
        } %}
        {% for job in failed_jobs %}
        <div class="queue-failed-item">
            <div class="queue-failed-header">
                <span class="queue-failed-reg">{{ job.registration }}</span>
                <span class="queue-failed-source">{{ source_names.get(job.source, job.source) }}</span>
            </div>
            {% if job.error_message %}
            <div class="queue-failed-error">{{ job.error_message }}</div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
